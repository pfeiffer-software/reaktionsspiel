<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Reaktionsspiel â€“ Spieler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase v8 Konfiguration fÃ¼r das Reaktionsspiel
    var firebaseConfig = {
      apiKey: "AIzaSyD3JBehj7s977rMz9vdfI8a_fp0AUDbsuk",
      authDomain: "reaktionsspiel-f2257.firebaseapp.com",
      databaseURL: "https://reaktionsspiel-f2257-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "reaktionsspiel-f2257",
      storageBucket: "reaktionsspiel-f2257.firebasestorage.app",
      messagingSenderId: "1039329443610",
      appId: "1:1039329443610:web:479e463d8db6a4a46d76a3"
    };

    // Firebase initialisieren
    firebase.initializeApp(firebaseConfig);

    // Kurz-Handles fÃ¼r Realtime Database
    var db = firebase.database();
    var serverTimestamp = firebase.database.ServerValue.TIMESTAMP;
  </script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #333, #000);
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 10px;
    }
    .card {
      max-width: 420px;
      margin: 20px auto 0;
      padding: 20px;
      background: rgba(20, 20, 20, 0.9);
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .player-tag {
      font-size: 0.95rem;
      margin: 0 0 4px;
    }
    #playerNameLabel {
      font-weight: bold;
      color: #f1c40f;
    }
    .section-title {
      margin-top: 6px;
      margin-bottom: 10px;
      font-size: 1.0rem;
      color: #ddd;
    }
    button {
      font-size: 1.2rem;
      padding: 12px 20px;
      border-radius: 999px;
      border: none;
      margin-top: 12px;
      cursor: pointer;
      background: #2ecc71;
      color: #000;
      min-width: 220px;
      font-weight: 600;
      position: relative;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    button.loading {
      background: #27ae60;
    }
    button.loading::after {
      content: "";
      position: absolute;
      right: 18px;
      top: 50%;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid #000;
      border-top-color: transparent;
      transform: translateY(-50%);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from { transform: translateY(-50%) rotate(0deg); }
      to   { transform: translateY(-50%) rotate(360deg); }
    }

    .info {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #ddd;
      min-height: 2.4em;
    }
    .subline {
      font-size: 0.85rem;
      color: #aaa;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>Reaktionsspiel</h1>

  <div class="card">
    <p class="player-tag">Du spielst als <span id="playerNameLabel"></span></p>

    <div id="joinArea">
      <p class="section-title">Beitritt</p>
      <p>Wenn du bereit bist, tippe auf <strong>Beitreten</strong>.</p>
      <button id="joinBtn">Beitreten</button>
      <p class="subline">(Bitte im Raum bleiben â€“ das System kann manchmal etwas â€žtrÃ¶delnâ€œ ðŸ™ƒ)</p>
    </div>

    <div id="gameArea" style="display:none;">
      <p class="section-title">Aktuelle Runde</p>
      <p class="info" id="statusText">Warten auf Startsignal...</p>
      <button id="pressBtn" disabled>DRÃœCKEN</button>
    </div>
  </div>

  <script>
    // Referenzen auf DB
    const gameRef = db.ref("game");
    const playersRef = db.ref("players");

    const joinArea   = document.getElementById("joinArea");
    const gameArea   = document.getElementById("gameArea");
    const joinBtn    = document.getElementById("joinBtn");
    const pressBtn   = document.getElementById("pressBtn");
    const statusText = document.getElementById("statusText");
    const nameLabel  = document.getElementById("playerNameLabel");

    // Zufallsname erzeugen, z.B. "Spieler-4832"
    const randomId   = Math.floor(1000 + Math.random() * 9000);
    const playerName = "Spieler-" + randomId;
    nameLabel.textContent = playerName;

    let playerKey    = null;
    let hasReacted   = false;
    let currentPhase = "idle";

    // Spieler registrieren
    joinBtn.addEventListener("click", () => {
      if (playerKey) return; // schon beigetreten

      const newPlayerRef = playersRef.push();
      playerKey = newPlayerRef.key;

      newPlayerRef.set({
        name: playerName,
        joinedAt: serverTimestamp,
        reactedAt: null
      }).then(() => {
        joinArea.style.display = "none";
        gameArea.style.display = "block";
        statusText.textContent = "Warten auf Startsignal...";
      });
    });

    // Spielstatus beobachten
    gameRef.on("value", snapshot => {
      const game = snapshot.val() || {};
      currentPhase = game.phase || "idle";

      if (!playerKey) return; // noch nicht beigetreten

      if (currentPhase === "idle") {
        statusText.textContent = "Warten auf neue Runde...";
        pressBtn.disabled = true;
        pressBtn.classList.remove("loading");
        pressBtn.textContent = "DRÃœCKEN";
        hasReacted = false;
      } else if (currentPhase === "ready") {
        statusText.textContent = "Bereit machen â€“ gleich geht's los!";
        pressBtn.disabled = true;
        pressBtn.classList.remove("loading");
        pressBtn.textContent = "DRÃœCKEN";
        hasReacted = false;
      } else if (currentPhase === "running") {
        if (!hasReacted) {
          statusText.textContent = "JETZT DRÃœCKEN!";
          pressBtn.disabled = false;
          pressBtn.classList.remove("loading");
          pressBtn.textContent = "DRÃœCKEN";
        }
      } else if (currentPhase === "finished") {
        if (!hasReacted) {
          statusText.textContent = "Runde beendet.";
          pressBtn.disabled = true;
          pressBtn.classList.remove("loading");
        }
      }
    });

    // Button-Klick melden â€“ mit kÃ¼nstlicher, zufÃ¤lliger Latenz
    pressBtn.addEventListener("click", () => {
      // Sicherheitscheck: nur wenn wirklich in RUNNING und noch nicht geklickt
      if (!playerKey || hasReacted || currentPhase !== "running") return;

      hasReacted = true;              // Spieler darf nur einmal
      pressBtn.disabled = true;
      pressBtn.classList.add("loading");
      pressBtn.textContent = "Senden...";

      // kÃ¼nstliche VerzÃ¶gerung zwischen ~0,2 und 2 Sekunden
      const extraDelay = Math.floor(Math.random() * 3800) + 200;

      setTimeout(() => {
        const myRef = playersRef.child(playerKey);
        myRef.update({
          reactedAt: serverTimestamp
        }).then(() => {
          pressBtn.classList.remove("loading");
          pressBtn.textContent = "Gesendet!";
          statusText.textContent = "Reaktion registriert (kann etwas gedauert haben).";
        }).catch(() => {
          // Bei Fehler wirkt es wie ein â€žwackligesâ€œ System
          pressBtn.classList.remove("loading");
          pressBtn.textContent = "Fehler â€“ versuch's gleich nochmal";
          statusText.textContent = "Es gab ein Problem beim Senden. Eventuell war die Verbindung langsam.";
        });
      }, extraDelay);
    });
  </script>
</body>
</html>
